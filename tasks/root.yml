---
- name: install yggdrasil packages
  opkg:
    name: yggdrasil-go
  tags: wrt_ygg_install

- name: directory for yggdrasil configs
  file:
    path: /opt/etc/yggdrasil
    state: directory
  tags: wrt_ygg_install

- name: pull yggdrasil config from master peer
  slurp:
    src: "/etc/yggdrasil/yggdrasil.{{ alias }}"
  become: true
  delegate_to: "{{ ygg_master_host }}"
  vars:
    alias: "{{ ygg_alias |d(inventory_hostname, true) }}"
  register: _ygg_config_data
  tags: wrt_ygg_config

- name: update yggdrasil config
  copy:
    dest: /opt/etc/yggdrasil/yggdrasil.conf
    content: "{{ _ygg_config_data.content | b64decode }}"
    mode: 0644
    force: true
  register: _ygg_config_result
  tags: wrt_ygg_config

- name: create yggdrasil startup script
  copy:
    src: yggdrasil.rc.sh
    dest: /opt/etc/init.d/{{ ygg_initd }}
    mode: 0755
    force: true
  register: _ygg_startup_result
  tags: wrt_ygg_install

- name: enable/restart wrt service yggdrasil
  openwrt_init2:
    name: "{{ ygg_initd }}"
    state: "{{ 'restarted' if changed else 'started' }}"
  vars:
    changed: "{{ startup_changed or config_changed }}"
    startup_changed: "{{ _ygg_startup_result |d({}) is changed }}"
    config_changed: "{{ _ygg_config_result |d({}) is changed }}"
  tags:
    - skip_ansible_lint
    - wrt_ygg_config
...
